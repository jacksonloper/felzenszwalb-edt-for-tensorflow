# Apache 2.0 Jackson Loper 2021
# Modified from https://github.com/tensorflow/custom-op
from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import numpy as np

from tensorflow.python.framework import ops
from tensorflow.python.platform import test
from tensorflow.python.framework import test_util
try:
  from tensorflow_felzenszwalb_edt.python.ops import time_two_ops
except ImportError:
  import time_two_ops

example_data = np.array([[[ 4.2521796,  1.1078081,  5.76698  ,  4.24422  ,  4.070083 ,
          3.1321592,  2.1059186,  6.875086 ,  2.8530664,  2.575548 ,
          6.906778 ],
        [ 5.4675326,  1.6570683,  5.2483087,  1.9681222, 10.159657 ,
         11.814511 ,  4.9851446, 11.626663 ,  1.3587035,  5.1336946,
          1.2878512],
        [ 4.1596966,  1.4457178,  1.6141438,  6.5004377,  2.259326 ,
          1.5014305,  2.2175596,  3.319797 ,  4.64144  ,  2.0856755,
          7.241127 ],
        [ 4.8377833,  5.133567 ,  3.6997416, 10.349959 ,  6.232079 ,
          1.8250335,  8.366895 , 14.895439 ,  5.062613 , 12.7469425,
          3.239738 ],
        [ 6.031645 ,  4.1529856,  4.261098 ,  9.961362 ,  5.560542 ,
         14.570319 ,  5.6862164,  1.3710757,  3.485284 , 11.735062 ,
          3.9109392]],

       [[ 1.1133304,  2.419428 ,  1.2968589, 15.80417  , 15.07914  ,
         10.503628 ,  6.5834227,  9.703744 ,  1.86893  ,  2.79528  ,
          5.395306 ],
        [ 3.3871806,  1.1956209, 15.467684 ,  4.316023 ,  5.1167226,
          3.0686688,  2.518432 ,  3.699712 , 11.264655 ,  9.098007 ,
          3.6184478],
        [ 1.0530949, 10.437193 ,  2.5964422,  6.2744813,  1.106188 ,
          7.6337023,  3.706477 ,  5.023112 ,  4.007838 ,  3.3300953,
          5.7865863],
        [15.150596 ,  1.5333148,  2.9744105,  1.1779683,  9.132688 ,
          7.5479174,  2.176628 ,  4.028813 ,  7.301973 ,  7.620472 ,
          1.8769459],
        [12.535955 ,  9.9939   ,  1.6534158, 12.199997 ,  9.352735 ,
         10.464645 ,  5.6735168,  2.221427 , 13.545959 ,  6.424873 ,
          3.284636 ]],

       [[ 2.550844 , 13.418099 ,  4.06284  ,  5.627285 ,  6.693015 ,
         11.123482 ,  6.9482713,  1.9172598,  6.41153  ,  4.9191413,
          5.740905 ],
        [ 8.342683 ,  2.4088452,  1.9827005,  1.521263 ,  2.6348658,
          1.0416348,  7.0480328,  2.81391  ,  1.9871112,  1.4391743,
          2.7159996],
        [ 2.1786978,  2.7316716,  4.6874285,  5.764515 , 11.590228 ,
         15.635467 ,  1.2102734,  2.3046744,  7.2925515,  1.8198134,
         12.232126 ],
        [ 2.1965275,  9.2034   ,  7.4664297, 10.471625 ,  1.1309717,
          2.2856975,  8.443412 ,  1.3989974,  1.1280876,  3.3922834,
          6.387785 ],
        [ 1.2258313,  1.2896761,  1.1856917,  3.7886505,  7.7487006,
          2.059997 , 12.393045 ,  4.209631 ,  6.88138  ,  2.7728949,
          6.807128 ]],

       [[14.567865 ,  4.3963466,  2.1227596,  4.127691 ,  4.3547125,
          5.166122 ,  5.418941 ,  1.1808269,  1.8383883,  4.4232774,
          8.509854 ],
        [ 9.984455 ,  9.973564 ,  5.1001177, 14.660177 ,  3.1466773,
          4.816788 ,  9.344097 , 11.91332  ,  4.0027895, 11.680225 ,
          4.3546724],
        [ 8.665888 ,  1.0342242,  1.1046808, 14.177847 ,  1.4755156,
          7.6294003,  2.7117956,  2.0794284,  3.7151475, 13.7574005,
          6.079978 ],
        [13.496769 ,  8.396686 ,  5.0789423,  5.1451735,  2.2067819,
          1.018785 ,  4.041144 ,  5.973844 , 12.400853 ,  7.9202332,
         11.520533 ],
        [13.764822 , 14.197303 , 10.876313 ,  1.6385376,  3.2884645,
          2.1329968, 12.159963 , 10.319819 ,  3.3116918,  6.062439 ,
         10.617822 ]],

       [[11.292827 ,  2.113937 ,  8.971546 , 10.577473 ,  1.1840012,
          1.5027424,  4.2413964,  2.2217422, 12.508525 ,  8.745772 ,
          8.610668 ],
        [ 9.81195  ,  3.136043 ,  2.2785394,  6.995997 ,  4.003007 ,
         14.070909 ,  7.277315 ,  3.6998236, 11.843709 ,  3.6350784,
          1.9276936],
        [10.076246 ,  4.6976147,  2.5163188,  8.203729 , 15.3846035,
          2.4122686, 10.271852 ,  9.6461525,  1.573743 , 11.434967 ,
          4.565404 ],
        [ 1.6062615,  5.571258 ,  2.8255773,  1.910829 ,  1.3566543,
          2.066001 ,  4.1768064,  7.2659674,  1.3980544,  8.665555 ,
          1.4734114],
        [ 1.9100157,  8.616989 , 12.632474 , 15.467213 ,  7.464378 ,
          4.768566 ,  1.4001558,  5.906492 ,  1.9463483,  5.259746 ,
          6.701141 ]],

       [[11.294089 ,  3.07061  , 15.646553 , 15.839019 , 11.12107  ,
          8.237778 ,  9.033697 , 12.366709 , 14.503848 , 11.770924 ,
          7.2505236],
        [ 1.328023 ,  6.9452167,  3.3532488,  1.84066  , 12.845616 ,
         11.090401 ,  5.4318123,  4.586809 ,  4.9196053,  2.5262399,
          3.8706357],
        [ 4.26018  ,  1.0615984, 12.838553 ,  1.1217952,  3.5526025,
          1.4422529,  2.052697 , 14.235513 ,  3.5358462,  8.936774 ,
          1.6084241],
        [ 2.4514446, 12.524848 , 13.122768 ,  2.748979 , 14.973294 ,
          7.7426147,  5.103214 ,  3.6057856,  3.1989253, 14.518735 ,
          8.221865 ],
        [ 5.5388117,  1.1856395,  2.4223287, 14.257515 ,  5.874872 ,
          3.3961172,  1.0383407,  2.4692454,  2.474595 ,  1.8782829,
          3.2723763]],

       [[ 2.091971 ,  1.2763569,  1.4532713,  5.0184655,  1.3091336,
         14.023672 ,  2.116069 ,  4.5963836,  4.005147 ,  2.7807333,
          3.06855  ],
        [ 2.154932 ,  2.686606 ,  1.5573134,  8.142873 ,  7.3141384,
          2.9587762, 12.499931 ,  3.6942286,  6.7371845,  5.382608 ,
          3.0827477],
        [13.8688545, 11.66802  , 11.490294 , 14.586625 ,  1.0099667,
          4.9569435, 14.103835 ,  1.6561736,  2.4025323,  5.1311827,
          7.9360456],
        [ 3.1550608,  2.9124448,  9.944299 ,  1.138035 , 10.170193 ,
          4.164568 ,  7.041974 ,  8.460772 ,  1.455964 , 13.137944 ,
         11.0278635],
        [ 3.578431 ,  2.0378518,  1.2758954,  2.9325101,  8.614382 ,
         10.808497 ,  3.0970247,  2.2174408,  3.104557 , 14.889852 ,
          1.4433975]],

       [[ 1.8243104,  8.239461 ,  1.687559 ,  2.5739105, 10.571883 ,
          2.8614802,  6.5048556,  6.119382 ,  2.5643127,  2.4315329,
          2.7664435],
        [12.384425 ,  1.0771704,  1.4200776,  3.2358403,  2.2175264,
          5.96592  ,  5.6166177,  5.000177 ,  2.8627238,  5.2188363,
         10.180007 ],
        [10.792384 ,  5.5206256, 10.64617  ,  1.1443132,  1.773874 ,
          9.340058 ,  3.6782048,  3.0166702,  6.1068873,  3.5477157,
         13.295536 ],
        [ 3.7005801, 11.36911  ,  6.582545 , 13.364989 ,  4.8506317,
         14.713188 ,  6.1802626,  1.1156816,  9.142591 , 12.004929 ,
          1.4563955],
        [14.861862 ,  5.9746075,  9.181162 ,  2.244541 , 14.199252 ,
          7.292854 ,  5.6731257, 14.799806 ,  5.876511 ,  5.5037537,
          1.1914552]],

       [[ 5.7184057,  9.258601 ,  3.5063589,  7.9531665,  5.9850354,
          2.1292753,  5.7246943,  4.7460485,  3.202288 ,  7.641663 ,
          1.2679826],
        [ 3.5513456,  4.22989  , 15.180011 ,  8.31677  ,  6.9864464,
          1.785451 ,  4.2415004,  3.5354743, 14.176299 ,  4.454966 ,
         11.843206 ],
        [ 7.4771194, 12.4730425,  1.0134087, 13.7256155, 14.4974165,
          1.7792253,  1.2899036,  3.011042 ,  6.320126 ,  5.3962193,
          4.241857 ],
        [13.383407 ,  6.075371 , 13.994221 ,  6.1715603,  1.9730475,
         15.434181 , 15.952158 ,  4.3775935,  9.648239 ,  7.1735044,
          1.9734722],
        [ 6.2194314,  7.488522 ,  6.4516425,  5.64609  ,  6.421556 ,
          8.530201 ,  9.836773 ,  1.406668 , 13.406326 ,  4.415935 ,
          8.285896 ]],

       [[ 3.7077124,  1.2204088,  7.660176 ,  3.4783323,  5.8135266,
          2.5736175,  2.1005216,  2.8228948, 11.508896 , 13.703578 ,
         15.325604 ],
        [ 4.001328 ,  9.885935 ,  1.8614457,  9.2563715,  4.1142592,
         11.564595 ,  2.0530806, 10.945867 ,  1.3222277, 11.615239 ,
          4.107822 ],
        [ 1.6933578,  2.908456 ,  8.537606 ,  4.375377 ,  2.3132615,
          2.3548129,  8.218747 ,  7.3720083,  1.2812805, 10.792673 ,
          1.6900519],
        [ 2.36852  ,  1.056786 ,  5.14747  , 11.737129 , 13.867321 ,
          4.5850606,  1.4787921,  4.7244306,  2.773166 ,  2.939583 ,
          2.386862 ],
        [14.568807 ,  3.8132546,  1.0143706,  4.998842 ,  8.355987 ,
         10.858385 ,  9.451722 ,  8.394674 ,  2.0604682,  3.3225434,
          4.53715  ]]], dtype=np.float32)

class TimeTwoTest(test.TestCase):
  @test_util.run_gpu_only
  def testTimeTwo(self):
    with self.test_session():
      with ops.device("/gpu:0"):
        out,z,v,basins=time_two_ops.basin_finder(example_data)
        self.assertAllClose(out[2,:,3],np.array([2.5212631, 1.521263 , 2.5212631, 4.7886505, 3.7886505]))

  def testTimeTwoCPU(self):
    with self.test_session():
      with ops.device("/cpu:0"):
        out,z,v,basins=time_two_ops.basin_finder(example_data)
        self.assertAllClose(out[2,:,3],np.array([2.5212631, 1.521263 , 2.5212631, 4.7886505, 3.7886505]))


if __name__ == '__main__':
  test.main()
